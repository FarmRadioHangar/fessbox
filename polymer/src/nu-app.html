<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="nu-add-contact-dialog.html">
<link rel="import" href="nu-call-dialog.html">
<link rel="import" href="nu-channel-list.html">
<link rel="import" href="nu-contacts.html">
<link rel="import" href="nu-header.html">
<link rel="import" href="nu-logs.html">
<link rel="import" href="nu-message-dialog.html">
<link rel="import" href="nu-message-list.html">
<link rel="import" href="nu-topic-dialog.html">

<dom-module id="nu-app">

  <template>

    <style>

      :host {}

      app-header {
        height: 113px;
      }

      paper-fab {
        position: fixed;
        right: 30px;
        bottom: 30px;
      }

    </style>

    <div>

      <app-drawer-layout force-narrow>

        <app-drawer id="drawer" align="right"></app-drawer>

        <app-header-layout>

          <app-header fixed>
            <nu-header 
              selected         = "{{selected}}"
              online           = "[[online]]"
              on-hamburger-tap = "handleHamburgerTap"
              on-topic-tap     = "handleTopicTap">
            </nu-header>
          </app-header>

          <iron-pages selected=[[selected]]>
            <nu-channel-list>
              <paper-fab onclick="callDialog.open()" icon="communication:phone"></paper-fab>
            </nu-channel-list>
            <nu-message-list>
              <paper-fab onclick="messageDialog.open()" icon="communication:message"></paper-fab>
            </nu-message-list>
            <nu-logs>
            </nu-logs>
            <nu-contacts>
              <paper-fab onclick="newContactModal.open()" icon="create"></paper-fab>
            </nu-contacts>
          </iron-pages>

        </app-header-layout>

      </app-drawer-layout>

    </div>

    <nu-call-dialog id="callDialog"></nu-call-dialog>
    <nu-message-dialog id="messageDialog"></nu-message-dialog>
    <nu-topic-dialog id="topicDialog"></nu-topic-dialog>
    <nu-add-contact-dialog id="newContactModal"></nu-add-contact-dialog>

  </template>

  <script>

    var store = Redux.createStore(function(state, action) {
      if (!state) {
        return {
          messages: []
        }
      }
      switch (action.type) {
        case 'MESSAGE_LIST_INIT':
          console.dir(action.ids);
          return state;
          break;
        default:
          return state;
      }
    });

    var ReduxBehavior = PolymerRedux(store);

    Polymer({

      is: "nu-app",

      _socket: null,

      ready: function() {
        this._socket = new WebSocket('ws://192.168.1.7:19998');
        this._socket.onerror = this.onError.bind(this);
        this._socket.onopen = this.onOpen.bind(this);
        this._socket.onmessage = this.onMessage.bind(this);
      },

      /*
      created: function() {
        var state = this.getState();
        console.log(state);
      },
      */

      _fetchMessages: function() {
        this._socket.send(JSON.stringify({
          event: 'inboxFetch',
          data: {
            filter: [], 
            after_id: null,
            count: 1100
          }
        }));
      },

      onError: function(event) {
        console.log('error');
      },

      onOpen: function(event) {
        this._fetchMessages();
      },

      onMessage: function(event) {
        var response;

        try {
          response = JSON.parse(event.data);
        } catch(e) {
          console.error(e);
          return;
        }
        if (response.event == "inboxMessages") {
          window.setTimeout(function() {
            this.dispatch({
              type: 'MESSAGE_LIST_INIT',
              ids: response.data.ids,
              messages: response.data.messages
            });
          }.bind(this), 700); 
        } else {
          console.log(response.event);
        }
      },

      handleHamburgerTap: function(event) {
        drawer.toggle();
      },

      handleTopicTap: function(event) {
        topicDialog.open();
      },

      behaviors: [Polymer.AppNetworkStatusBehavior, ReduxBehavior]

    });

  </script>

</dom-module>
