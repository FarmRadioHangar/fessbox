<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="nu-message-item.html">

<dom-module id="nu-message-list">

  <template>

    <style>

      :host {
        display: block;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      iron-list {
        flex: 1 1 auto;
      }

      .list-item {
        height: 80px;
      }

      paper-spinner {
        --paper-spinner-stroke-width: 6px;
        width: 128px; 
        height: 128px; 
        left: calc(50vw - 64px);
      }

      .spinner-container {
        position: absolute;
        display: flex; 
        align-items: center; 
        width: 100vw; 
        height: calc(100vh - 230px);
      }

    </style>

    <div class="spinner-container">
      <paper-spinner alt="Loading messages" active=[[loading]]></paper-spinner>
    </div>

    <iron-list 
      hidden$        = "[[loading]]"
      items          = "[[items]]"
      selected-items = "{{selectedItems}}"
      selection-enabled 
      multi-selection>

      <template>
        <div class="list-item">
          <nu-message-item
            item = "[[item]]">
          </nu-message-item>
        </div>
      </template>

    </iron-list>
      
    <content></content>

  </template>

  <script>

    Polymer({

      is: "nu-message-list",

      ready: function() {
        var self = this;
        this._ws = new WebSocket("ws://192.168.1.7:19998");
        //this._ws = new WebSocket("ws://thehangar.farmradio.org:51234");
        this._ws.onmessage = function(event) {
          var response = JSON.parse(event.data);
          if (response.event == "inboxMessages") {
            window.setTimeout(function() {
              response.data.ids.forEach(function(id) {
                var message = response.data.messages[id];
                self.push('items', message);
              });
              self.set('loading', false);
              localStorage.setItem('_voxbox_messageIds', JSON.stringify(response.data.ids));
              localStorage.setItem('_voxbox_messages', JSON.stringify(response.data.messages));
            }, 700);
          }
        }
        this._ws.onopen = function(event) {
          var self = this;
          this.fetchMessages();
          window.setInterval(function() {
            self._ws.send(JSON.stringify({event: 'ping', data: null}));
            console.log('Ping?');
          }, 4000);
        }.bind(this);
      },

      fetchMessages: function() {
        this.set('loading', true);
        this._ws.send(JSON.stringify({
          event: 'inboxFetch',
          data: {
            filter: [], 
            after_id: null,
            count: 1100
          }
        }));
      },

      properties: {
        items: {
          type: Array,
          value: [],
          notify: true
        },
        loading: {
          type: Boolean,
          value: true
        }
      }

    });

  </script>

</dom-module>
