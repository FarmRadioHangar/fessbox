<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="nu-message-item.html">
<link rel="import" href="nu-message-ribbon.html">
<link rel="import" href="nu-overlay.html">

<dom-module id="nu-message-list">

  <template>

    <style>

      :host {
        display: block;
        height: calc(100vh - 115px);
        width: 100vw;
        display: flex;
        flex-direction: column;
      }

      iron-list {
        flex: 1 1 auto;
      }

      .list-item {
        height: 230px;
        width: 290px;
      }

      paper-spinner {
        --paper-spinner-stroke-width: 6px;
        width: 128px; 
        height: 128px; 
        left: calc(50vw - 64px);
      }

      paper-fab {
        position: fixed;
        right: 30px;
        bottom: 100px;
        z-index: 200;
        background: white;
        --paper-fab-background: { color: white; }
        --paper-fab-iron-icon: { color: grey; }
      }

      .spinner-container {
        position: absolute;
        display: flex; 
        align-items: center; 
        width: 100vw; 
        height: calc(100vh - 230px);
        pointer-events: none;
      }

    </style>

    <nu-message-ribbon
      has-selection = "[[selectedItems.length]]">
    </nu-message-ribbon>

    <nu-overlay id="actions">
      <p>Hello world!</p>
      <button>Button</button>
      <button onclick="actions.close()">Close</button>
    </nu-overlay>

    <paper-fab icon="hardware:keyboard-arrow-down"></paper-fab>

    <iron-list 
      id             = "messageList"
      hidden$        = "[[loading]]"
      items          = "[[items]]"
      selected-items = "{{selectedItems}}"
      selection-enabled 
      multi-selection
      grid>

      <template>
        <div class="list-item">
          <nu-message-item 
            item               = "[[item]]"
            index              = "[[index]]"
            selected           = "[[selected]]"
            on-toggle-selected = "toggleSelected"
            on-tap-action-menu = "showOverlay">
          </nu-message-item>
        </div>
      </template>

    </iron-list>

    <div class="spinner-container">
      <paper-spinner 
        alt    = "Loading messages"
        active = [[loading]]>
      </paper-spinner>
    </div>

    <content></content>

  </template>

  <script>

    Polymer({

      is: "nu-message-list",

      isEmpty: function(x) {
        console.log(x.length);
        return !!x.length;
      },

      _init: function(ids, messages) {
        ids.forEach(function(id) {
          var message = messages[id];
          this.push('items', message);
        }.bind(this));
        this.set('loading', false);
        document.querySelector('iron-list').fire('iron-resize');
      },

      ready: function() {
        console.log('ready');
        var self = this;
        this._ws = new WebSocket("ws://192.168.1.7:19998");
        //this._ws = new WebSocket("ws://thehangar.farmradio.org:51234");
        this._ws.onmessage = function(event) {
          var response = JSON.parse(event.data);
          if (response.event == "inboxMessages") {
            window.setTimeout(function() {
              self._init(response.data.ids, response.data.messages);
              localStorage.setItem('_voxbox_messageIds', JSON.stringify(response.data.ids));
              localStorage.setItem('_voxbox_messages', JSON.stringify(response.data.messages));
            }, 700); 
          } else {
            console.log(response.event);
          }
        }
        this._ws.onopen = function(event) {
          var self = this;
          this.fetchMessages();
          window.setInterval(function() {
            self._ws.send(JSON.stringify({event: 'ping', data: null}));
            console.log('Ping?');
          }, 4000);
        }.bind(this);
        this._ws.onerror = function(event) {
          var ids = JSON.parse(localStorage.getItem('_voxbox_messageIds'));
          var messages = JSON.parse(localStorage.getItem('_voxbox_messages'));
          console.log(messages);
          this._init(ids, messages);
        }.bind(this);
      },

      showOverlay: function(event) {
        actions.open();
      },

      toggleSelected: function(event) {
        this.$.messageList.toggleSelectionForItem(event.model.item);
      },

      fetchMessages: function() {
        this.set('loading', true);
        this._ws.send(JSON.stringify({
          event: 'inboxFetch',
          data: {
            filter: [], 
            after_id: null,
            count: 1100
          }
        }));
      },

      properties: {
        items: {
          type: Array,
          value: [],
          notify: true
        },
        loading: {
          type: Boolean,
          value: true
        },
        selectedItems: {
          type: Object
        }
      }

    });

  </script>

</dom-module>
