<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="poly-channel-list.html">
<link rel="import" href="poly-contacts.html">
<link rel="import" href="poly-header.html">
<link rel="import" href="poly-logs.html">
<link rel="import" href="poly-message-list.html">

<dom-module id="poly-app">
  <template>

    <style>

      :host {}

      app-header {
        height: 113px;
      }

    </style>

    <app-drawer-layout force-narrow>

      <app-drawer id="drawer" align="right"></app-drawer>

      <app-header-layout>

        <app-header fixed>
          <poly-header
            selected        = "{{selected}}"
            online          = "[[online]]"
            on-tap-settings = "handleToggleSettings">
          </poly-header>
        </app-header fixed>

        <iron-pages selected=[[selected]]>
          <poly-channel-list></poly-channel-list>
          <poly-message-list></poly-message-list>
          <poly-logs></poly-logs>
          <poly-contacts></poly-contacts>
        </iron-pages>

      </app-header-layout>

    </app-drawer-layout>

  </template>

  <script>

    const initialState = [];

    function messageReducer(state = initialState, action) {
      console.log('Redux action received: <' + action.type + '>');
      switch (action.type) {
        default:
          return state;
      }
    }

    const store = Redux.createStore(Redux.combineReducers({
      messageReducer,
    }));

    class MessageHandler {

      constructor(dispatcher) {
        if (!dispatcher) {
          console.error('MessageHandler: No Redux dispatch function provided.');
          return;
        }
        if ('function' !== typeof dispatcher) {
          console.error('MessageHandler: Invalid Redux dispatch function.');
          return;
        }
        this.dispatch = dispatcher;
        this.socket = new WebSocket('ws://192.168.1.7:19998');
        this.socket.onerror = this.onError.bind(this);
        this.socket.onopen = this.onOpen.bind(this);
        this.socket.onclose = this.onClose.bind(this);
        this.socket.onmessage = this.onMessage.bind(this);
      }

      onError(event) {
        console.log('error');
      }

      onOpen(event) {
        console.log('open');
      }

      onClose(event) {
        console.log('close');
      }

      onMessage(event) {
        let response = null;
        try {
          response = JSON.parse(event.data);
        } catch(e) {
          console.error(e);
          return;
        }
        switch (response.event) {
          case 'initialize':
            /* @TODO */
            break;
          case 'inboxMessages':
            /* @TODO */
            break;
          default:
            console.warn('Unhandled message type: ' + response.event);
        }
      }

    }

    Polymer({

      is: 'poly-app',

      ready() {
        new MessageHandler(this.dispatch);
      },

      handleToggleSettings() {
        this.$.drawer.toggle();
      },

      behaviors: [
        Polymer.AppNetworkStatusBehavior, 
        PolymerRedux(store)
      ]

    });

  </script>
</dom-module>
